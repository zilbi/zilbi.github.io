<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Этичная диагностическая панель браузера</title>
<style>
  :root { --green:#00ff41; --bg:#000; --text:#0f0; --card:#061a06; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
  h1{font-weight:700; letter-spacing:.04em; color:var(--green); margin:.5rem 0 0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:var(--card); border:1px solid #0a360a; border-radius:8px; padding:12px}
  .row{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed #144}
  .row:last-child{border-bottom:0}
  .muted{opacity:.75}
  code.inline{background:#021; padding:.1em .35em; border-radius:4px}
  button{background:#021; color:var(--green); border:1px solid #093; border-radius:6px;
    padding:10px 14px; cursor:pointer; font-weight:600}
  button[disabled]{opacity:.5; cursor:not-allowed}
  .toggle-row{display:flex; gap:8px; flex-wrap:wrap}
  .log{height:150px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    background:#010; border:1px solid #083; border-radius:6px; padding:8px}
  .cam{width:100%; aspect-ratio:16/9; background:#000; border:1px solid #083; border-radius:6px}
  .kbd{display:inline-block; border:1px solid #093; border-radius:4px; padding:2px 6px; margin:2px; background:#021}
  .cursor-dot{position:fixed; width:10px;height:10px;border-radius:50%; border:1px solid #0f5; pointer-events:none; transform:translate(-50%,-50%); mix-blend-mode:screen}
  .consent{position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:1000}
  .consent .box{background:#031; border:1px solid #093; border-radius:12px; padding:18px; max-width:560px}
  .consent h2{margin:.3rem 0 0; color:var(--green)}
  .consent ul{margin:.3rem 0 1rem 1.2rem}
  .small{font-size:12px; opacity:.8}
</style>
</head>
<body>
<div class="wrap">
  <h1>Диагностическая панель (с вашим согласием)</h1>
  <p class="muted">Все данные остаются в вашем браузере и никуда не отправляются. Вы можете включать/выключать любую функцию.</p>

  <div class="grid">
    <section class="card">
      <h3>О системе</h3>
      <div class="row"><span>Браузер / UA</span><span id="ua"></span></div>
      <div class="row"><span>Платформа</span><span id="platform"></span></div>
      <div class="row"><span>Язык</span><span id="lang"></span></div>
      <div class="row"><span>Часовой пояс</span><span id="tz"></span></div>
      <div class="row"><span>Экран</span><span id="screen"></span></div>
      <div class="row"><span>Ядра CPU</span><span id="cpu"></span></div>
      <div class="row"><span>RAM (примерно)</span><span id="ram"></span></div>
      <div class="row"><span>Сеть (если доступно)</span><span id="net"></span></div>
      <div class="row"><span>Батарея</span><span id="bat"></span></div>
      <p class="small">Примечание: реальные IP-адреса браузер не раскрывает без сервера/стороннего API.</p>
    </section>

    <section class="card">
      <h3>Разрешения</h3>
      <div class="row"><span>Геолокация</span><span id="perm-geo" class="muted">—</span></div>
      <div class="row"><span>Камера</span><span id="perm-cam" class="muted">—</span></div>
      <div class="row"><span>Микрофон</span><span id="perm-mic" class="muted">—</span></div>
      <div class="row"><span>Клипборд (чтение)</span><span id="perm-clip" class="muted">—</span></div>
    </section>

    <section class="card">
      <h3>Управление</h3>
      <div class="toggle-row">
        <button id="btn-geo">Запросить геолокацию</button>
        <button id="btn-cam">Включить камеру</button>
        <button id="btn-cam-off" disabled>Выключить камеру</button>
        <button id="btn-keys">Включить показ клавиш</button>
        <button id="btn-keys-off" disabled>Выключить показ клавиш</button>
        <button id="btn-cursor">Включить отслеживание курсора</button>
        <button id="btn-cursor-off" disabled>Выключить курсор</button>
        <button id="btn-clear">Очистить лог</button>
      </div>
      <p class="small">Клавиши: показываются только имена клавиш (без текста), чтобы избежать кейлоггинга.</p>
    </section>

    <section class="card">
      <h3>Камера (по согласию)</h3>
      <video id="cam" class="cam" playsinline muted></video>
      <div id="cam-note" class="small muted">Камера выключена.</div>
    </section>

    <section class="card">
      <h3>Геолокация (по согласию)</h3>
      <div class="row"><span>Широта</span><span id="lat">—</span></div>
      <div class="row"><span>Долгота</span><span id="lon">—</span></div>
      <div class="row"><span>Точность</span><span id="acc">—</span></div>
      <div class="row"><span>Источник</span><span id="src">—</span></div>
    </section>

    <section class="card">
      <h3>События</h3>
      <div style="margin:.2rem 0 .4rem">Последние клавиши: <span id="keys"></span></div>
      <div style="margin:.2rem 0 .4rem">Позиция курсора: <code class="inline" id="cursor">x: —, y: —</code></div>
      <div class="log" id="log" aria-live="polite"></div>
    </section>
  </div>
</div>

<!-- Диалог согласия -->
<div class="consent" id="consent">
  <div class="box">
    <h2>Согласие на демонстрацию доступных данных</h2>
    <p>Эта страница может (по вашему выбору) отобразить:</p>
    <ul>
      <li>Технические сведения о браузере/устройстве.</li>
      <li>Статус разрешений (гео/камера/микрофон/клипборд).</li>
      <li>Геолокацию и/или превью с камеры — только после явного разрешения.</li>
      <li>Визуализацию нажатых клавиш (без текста) и позиции курсора.</li>
    </ul>
    <p class="small">Ничего никуда не отправляется — всё остаётся в вашем браузере.</p>
    <div class="toggle-row">
      <button id="agree">Согласен(на) и продолжить</button>
      <button id="decline">Выйти</button>
    </div>
  </div>
</div>

<script>
  // ==== Утилиты ====
  const $ = sel => document.querySelector(sel);
  const logEl = $('#log');
  const addLog = (msg) => {
    const t = new Date().toLocaleTimeString();
    logEl.textContent += `[${t}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  };
  const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };

  // ==== Базовая инфа ====
  function fillSystemInfo() {
    setText('ua', navigator.userAgent || '—');
    setText('platform', navigator.platform || navigator.userAgentData?.platform || '—');
    setText('lang', navigator.language || '—');
    try {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '—';
      setText('tz', tz);
    } catch { setText('tz','—'); }
    setText('screen', `${screen.width}×${screen.height} @${devicePixelRatio.toFixed(2)}x`);
    setText('cpu', navigator.hardwareConcurrency ?? '—');
    setText('ram', navigator.deviceMemory ? `${navigator.deviceMemory} GB` : '—');

    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (conn) {
      const parts = [];
      if (conn.effectiveType) parts.push(`тип: ${conn.effectiveType}`);
      if (conn.downlink) parts.push(`~${conn.downlink} Мбит/с`);
      if (conn.rtt) parts.push(`rtt ~${conn.rtt} мс`);
      setText('net', parts.join(', ') || '—');
    } else setText('net','—');

    if (navigator.getBattery) {
      navigator.getBattery().then(b => {
        setText('bat', `${(b.level*100).toFixed(0)}% ${b.charging ? '(зарядка)' : ''}`);
      }).catch(()=> setText('bat','—'));
    } else setText('bat','—');
  }

  // ==== Разрешения ====
  async function updatePermissions() {
    const q = async (name) => {
      try {
        const s = await navigator.permissions.query({name});
        return s.state; // 'granted' | 'denied' | 'prompt'
      } catch { return 'н/д'; }
    };
    setText('perm-geo', await q('geolocation'));
    setText('perm-cam', await q('camera'));
    setText('perm-mic', await q('microphone'));
    setText('perm-clip', await q('clipboard-read'));
  }

  // ==== Геолокация ====
  function requestGeo() {
    if (!navigator.geolocation) {
      addLog('Геолокация не поддерживается');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const {latitude, longitude, accuracy} = pos.coords;
        setText('lat', latitude.toFixed(6));
        setText('lon', longitude.toFixed(6));
        setText('acc', `${Math.round(accuracy)} м`);
        setText('src', pos.coords.altitude !== null ? 'GPS/барометр' : 'Сеть/GPS');
        addLog(`Геолокация получена: ${latitude.toFixed(5)}, ${longitude.toFixed(5)} ±${Math.round(accuracy)}м`);
        updatePermissions();
      },
      (err) => {
        addLog(`Геолокация: отказ/ошибка (${err.code}) ${err.message}`);
        updatePermissions();
      },
      {enableHighAccuracy:true, timeout:10000, maximumAge:0}
    );
  }

  // ==== Камера ====
  let camStream = null;
  async function startCam() {
    try {
      const v = $('#cam');
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {facingMode:'user', width:{ideal:1280}, height:{ideal:720}},
        audio: false
      });
      camStream = stream;
      v.srcObject = stream;
      await v.play();
      $('#cam-note').textContent = 'Камера активна. Изображение не записывается и никуда не отправляется.';
      addLog('Камера включена');
      updatePermissions();
      $('#btn-cam').disabled = true;
      $('#btn-cam-off').disabled = false;
    } catch (e) {
      addLog('Камера: отказ/ошибка — ' + (e?.message || e));
      updatePermissions();
    }
  }
  function stopCam() {
    if (camStream) {
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
      $('#cam').srcObject = null;
      $('#cam-note').textContent = 'Камера выключена.';
      addLog('Камера выключена');
      $('#btn-cam').disabled = false;
      $('#btn-cam-off').disabled = true;
    }
  }

  // ==== Клавиши (без текста) ====
  let keysOn = false;
  const keysEl = $('#keys');
  const pressed = new Set();
  const keyToLabel = (k) => k.length === 1 ? `Key(${k})` : k;

  function onKeyDown(e) {
    const label = keyToLabel(e.key);
    if (!pressed.has(label)) pressed.add(label);
    renderKeys();
  }
  function onKeyUp(e) {
    const label = keyToLabel(e.key);
    pressed.delete(label);
    renderKeys();
  }
  function renderKeys() {
    keysEl.innerHTML = '';
    if (pressed.size === 0) { keysEl.textContent = '—'; return; }
    pressed.forEach(k => {
      const span = document.createElement('span');
      span.className = 'kbd';
      span.textContent = k;
      keysEl.appendChild(span);
    });
  }
  function enableKeys() {
    if (keysOn) return;
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);
    keysOn = true;
    addLog('Отображение клавиш включено (без текста).');
    $('#btn-keys').disabled = true;
    $('#btn-keys-off').disabled = false;
  }
  function disableKeys() {
    if (!keysOn) return;
    window.removeEventListener('keydown', onKeyDown);
    window.removeEventListener('keyup', onKeyUp);
    pressed.clear();
    renderKeys();
    keysOn = false;
    addLog('Отображение клавиш выключено.');
    $('#btn-keys').disabled = false;
    $('#btn-keys-off').disabled = true;
  }

  // ==== Курсор ====
  let cursorOn = false;
  const cursorEl = $('#cursor');
  const dot = document.createElement('div');
  dot.className = 'cursor-dot';
  function onMouseMove(e) {
    cursorEl.textContent = `x: ${e.clientX}, y: ${e.clientY}`;
    dot.style.left = e.clientX + 'px';
    dot.style.top  = e.clientY + 'px';
  }
  function enableCursor() {
    if (cursorOn) return;
    document.body.appendChild(dot);
    window.addEventListener('mousemove', onMouseMove);
    cursorOn = true;
    addLog('Отслеживание курсора включено.');
    $('#btn-cursor').disabled = true;
    $('#btn-cursor-off').disabled = false;
  }
  function disableCursor() {
    if (!cursorOn) return;
    window.removeEventListener('mousemove', onMouseMove);
    dot.remove();
    cursorEl.textContent = 'x: —, y: —';
    cursorOn = false;
    addLog('Отслеживание курсора выключено.');
    $('#btn-cursor').disabled = false;
    $('#btn-cursor-off').disabled = true;
  }

  // ==== События UI ====
  $('#btn-geo').addEventListener('click', requestGeo);
  $('#btn-cam').addEventListener('click', startCam);
  $('#btn-cam-off').addEventListener('click', stopCam);
  $('#btn-keys').addEventListener('click', enableKeys);
  $('#btn-keys-off').addEventListener('click', disableKeys);
  $('#btn-cursor').addEventListener('click', enableCursor);
  $('#btn-cursor-off').addEventListener('click', disableCursor);
  $('#btn-clear').addEventListener('click', () => { logEl.textContent=''; });

  // ==== Согласие ====
  const consent = $('#consent');
  $('#agree').addEventListener('click', () => {
    consent.remove();
    fillSystemInfo();
    updatePermissions();
    addLog('Сессия начата: данные отображаются локально, по вашему выбору.');
  });
  $('#decline').addEventListener('click', () => {
    addLog('Согласие отклонено. Страница будет закрыта.');
    setTimeout(() => { window.location.replace('about:blank'); }, 400);
  });
</script>
</body>
</html>
